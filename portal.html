<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Showroom Digital | NEXUS V12</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #E31010; --secondary: #0056b3; --bg: #f4f7f6; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: #1a1a1c; font-family: 'Inter', sans-serif; }

        /* HEADER */
        .header { background: #fff; padding: 20px; text-align: center; border-bottom: 4px solid var(--secondary); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo-img { max-height: 50px; }

        /* FILTROS */
        .filter-bar { max-width: 1200px; margin: 20px auto; padding: 0 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #ddd; outline: none; min-width: 250px; }
        .search-input:focus { border-color: var(--secondary); }

        /* VITRINE */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .card { background: #fff; border-radius: 15px; overflow: hidden; border: 1px solid #eee; transition: 0.3s; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card:hover { transform: translateY(-5px); }

        /* CARROSSEL DE FOTOS */
        .carrossel { position: relative; width: 100%; aspect-ratio: 4/3; background: #eee; overflow: hidden; }
        .carrossel img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .card:hover .carrossel img { transform: scale(1.05); }
        
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; z-index: 10; }
        .prev { left: 10px; } .next { right: 10px; }

        /* BADGES */
        .badge { position: absolute; top: 10px; left: 10px; padding: 5px 12px; border-radius: 5px; font-size: 11px; font-weight: bold; z-index: 11; text-transform: uppercase; }
        .badge-destaque { background: #f1c40f; color: #000; }
        .badge-vendido { background: var(--primary); color: #fff; }

        /* INFO DO CARRO */
        .info { padding: 15px; }
        .tags { display: flex; gap: 5px; margin-bottom: 10px; }
        .tag { background: #f0f4f8; color: var(--secondary); padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        
        .title { font-size: 18px; font-weight: 900; margin-bottom: 5px; color: #333; }
        .price { font-size: 22px; font-weight: 900; color: var(--secondary); margin-bottom: 15px; }
        
        .btn-zap { background: #25d366; color: #fff; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .btn-zap:hover { filter: brightness(1.1); }

        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header class="header" id="header-content">
        <h1 style="color:var(--secondary)">NEXUS <span style="color:var(--primary)">V12</span></h1>
    </header>

    <div class="filter-bar">
        <input type="text" id="search" class="search-input" placeholder="O que você está procurando?" oninput="window.filtrar()">
    </div>

    <div class="grid" id="vitrine"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, getDoc, addDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBOCli1HzoijZ1gcplo_18tKH-5Umb63q8",
            authDomain: "nexus-v12.firebaseapp.com",
            projectId: "nexus-v12",
            storageBucket: "nexus-v12.firebasestorage.app",
            messagingSenderId: "587840382224",
            appId: "1:587840382224:web:61c0f1890c7c395dc77195"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const lojaId = urlParams.get('loja');

        window.estoqueLocal = [];

        // 1. CARREGAR IDENTIDADE
        if(lojaId) {
            onSnapshot(doc(db, "configuracoes", lojaId), (s) => {
                if(s.exists()){
                    const d = s.data();
                    document.documentElement.style.setProperty('--secondary', d.corLoja || '#0056b3');
                    if(d.logo) document.getElementById('header-content').innerHTML = `<img src="${d.logo}" class="logo-img">`;
                }
            });
        }

        // 2. CARREGAR ESTOQUE (Ordenado por destaques primeiro)
        const q = query(collection(db, "carros"), where("lojaId", "==", lojaId));
        onSnapshot(q, (snap) => {
            window.estoqueLocal = [];
            snap.forEach(d => window.estoqueLocal.push({ id: d.id, ...d.data() }));
            window.filtrar();
        });

        window.filtrar = async () => {
            const busca = document.getElementById('search').value.toLowerCase();
            const vitrine = document.getElementById('vitrine');
            vitrine.innerHTML = '';

            // Filtragem e Ordenação: Destaque > Disponível > Vendido
            const filtrados = window.estoqueLocal.filter(c => {
                const texto = (c.marca + " " + c.modelo).toLowerCase();
                return texto.includes(busca);
            }).sort((a, b) => {
                if(a.status === 'destaque') return -1;
                if(b.status === 'destaque') return 1;
                return 0;
            });

            for (const car of filtrados) {
                const vSnap = await getDoc(doc(db, "vendedores", car.vendedorId));
                const vend = vSnap.exists() ? vSnap.data() : { nome: "Consultor", whats: "" };
                
                const badge = car.status === 'vendido' ? '<span class="badge badge-vendido">VENDIDO</span>' : 
                             (car.status === 'destaque' ? '<span class="badge badge-destaque">★ DESTAQUE</span>' : '');

                vitrine.innerHTML += `
                    <div class="card">
                        ${badge}
                        <div class="carrossel">
                            <button class="nav-btn prev" onclick="window.swapImg('${car.id}', ${JSON.stringify(car.fotos).replace(/"/g, '&quot;')}, -1)"><i class="fa fa-chevron-left"></i></button>
                            <img src="${car.fotos[0]}" id="img-${car.id}">
                            <button class="nav-btn next" onclick="window.swapImg('${car.id}', ${JSON.stringify(car.fotos).replace(/"/g, '&quot;')}, 1)"><i class="fa fa-chevron-right"></i></button>
                        </div>
                        <div class="info">
                            <div class="tags">
                                <span class="tag">${car.ano}</span>
                                <span class="tag">${car.cambio}</span>
                                <span class="tag">${Number(car.km).toLocaleString()} KM</span>
                            </div>
                            <h3 class="title">${car.marca} ${car.modelo}</h3>
                            <div class="price">R$ ${car.preco.toLocaleString('pt-BR')}</div>
                            <a href="javascript:void(0)" onclick="window.gerarLead('${car.id}', '${car.marca} ${car.modelo}', '${vend.nome}', '${vend.whats}', '${lojaId}')" class="btn-zap">
                                <i class="fab fa-whatsapp"></i> Tenho Interesse
                            </a>
                        </div>
                    </div>
                `;
            }
        };

        window.swapImg = (id, fotos, dir) => {
            const el = document.getElementById('img-'+id);
            let idx = fotos.indexOf(el.src);
            if(idx === -1) idx = 0;
            let next = (idx + dir + fotos.length) % fotos.length;
            el.src = fotos[next];
        };

        window.gerarLead = async (id, carro, vNome, vWhats, lId) => {
            await addDoc(collection(db, "interesses"), {
                lojaId: lId,
                carro: carro,
                vendedor: vNome,
                vendedorWhats: vWhats,
                data: new Date()
            });
            window.open(`https://wa.me/${vWhats}?text=Olá! Vi o ${carro} no portal e quero saber mais.`, '_blank');
        };
    </script>
</body>
</html>
